## 读写文档

原文地址: [Reading and Writing documents](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-replication.html#docs-replication)

### Introduction（介绍）

在 Elasticsearch 中的每个索引都会被 拆分成分片，并且每个分片都有多个副本。这些副本称为 replication group（副本组）并且在删除或者添加文档的时候必须同步到各个副本。如果我们做不到这点，从不同副本中读取的数据会不一致。我们把保持分片和副本之间的同步以及从中读取的过程就是我们所说的 data replication model（数据复制模型）。
Elasticsearch 的 data replication model（数据复制模型）是基于primary-backup model （主备模型）的，并且 在Microsoft Research 的 PacificA paper 中描述得非常好。该模型以来自 replication group（副本组，实际是主分片）的单个副本为基础。其它副本叫做 replica shards（副本分片）。主分片是所有索引操作的入口。它负责验证索引操作是否有效。一旦主分片接受一个索引操作，主分片的副本分片也会接受该操作。
本节的目的是给出 Elasticsearch replication model 的高级概述，并讨论它对写操作和读操作之间的各种交互的影响。

### Basic write model（基础的写模型）

每个索引操作首先会使用 routing 参数解析到 replication group（分片组，包含主分片和副本分片） ，通常基于文档 ID。一旦确定 replication group，就会内部地转发该操作到分片组的主分片中。主分片负责验证操作和转发它到其他副本分片。Elasticsearch 维护一个可以接收该操作的分片的副本列表。这个列表叫做 in-sync copies（同步中的副本）并由 master 节点维护。正如名字那样，保证这些分片都会处理所有的索引和删除操作，这些操作都会经过用户确认。主分片负责维护不变性（各个副本保持一致），因此必须复制这些操作到列表中的每个副本。
主分片遵循以下基本流程 :

1. 验证操作，如果它的结构有错就拒绝该操作（例如，对 object 字段指定一个数字值）
2. 在本地执行操作。即索引或删除相关文档。这也会验证字段的内容，如果不通过就拒绝操作（例如，字段串的长度超出 Lucene 的定义的长度）
3. 转发该操作到当前 in-sync 副本组的所有副本分片。如果有多个副本分片，会并行转发。
4. 一旦所有的副本分片成功执行该操作就会返回给主分片，主分片把请求的成功执行的信息返回给用户。

### Failure handling（故障处理）

索引期间会发生很多错误 - 硬盘坏了，节点丢失和其他节点的连接，或者某些配置错误会导致不能在副本分片上执行某个操作，尽管该操作成功在主分片上执行。虽然这是罕见的，但是主分片必须汇报这些错误信息。
对于主分片自身错误的情况，它所在的节点会发送一个消息到 master 节点。这个索引操作会等待（默认 最多一分钟）master 节点提升一个副本分片为主分片。这个操作会被转发给新的主分片处理。注意 master 同样会监控节点的健康，并且可能会主动降级主分片。这通常发生在主分片所在的节点和集群失去联系的时候。点击这里 查看更多细节。
一旦在主分片执行的操作成功，该主分片必须处理在副本分片上潜在发生的错误。错误发生的原因可能是，在副本分片上执行操作时发生的错误，也可能是因为网络阻塞，导致主分片无法转发操作到副本分片，或者副本分片无法返回结果给主分片。这些错误都会导致相同的结果 : in-sync replica set 中的一个分片丢失一个即将要确认的操作。为了避免出现不一致，主分片会发送一条消息到 master 节点，要求它把有问题的分片从 in-sync replica set 中移除。 一旦 master 确认移除了该分片，主分片就会确认这次操作。注意 master 也会指导另一个节点建立一个新的分片副本，以便把系统恢复成健康状态。
在转发请求到副本分片时，主分片会使用副本分片来验证它是否仍是一个活跃的主分片。如果主分片因为网络原因（或很长的 GC）被隔离了，在它被降级之前它会继续处理传入的索引操作。来自陈旧的主分片的操作将会被副本分片拒绝。当主分片接收到来自拒绝其请求的响应时，因为它不再是主节点，所以它将会访问到主节点，并且将会知道它已被替换。 然后将操作路由到新的主分片。


>